<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ÙØªÙˆØ­ + Ø§ÛŒØ±Ø§Ù†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; }
        .vip-card { border: 3px solid #FFD700; background: linear-gradient(to bottom right, #fff, #fffde6); position: relative; }
        .vip-badge { position: absolute; top: 10px; right: 10px; background-color: #FFD700; color: #8B4513; padding: 4px 8px; border-radius: 5px; font-size: 0.75rem; font-weight: bold; }
        .chat-bubble { max-width: 80%; border-radius: 15px; padding: 10px; margin: 5px; word-wrap: break-word; }
        .chat-owner { background-color: #d1fae5; align-self: flex-end; } /* Green for owner */
        .chat-other { background-color: #eff6ff; align-self: flex-start; } /* Blue for other */
        .ad-image { width: 100%; height: 180px; object-fit: cover; border-radius: 8px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <nav class="bg-blue-800 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="font-bold text-2xl">Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ÙØªÙˆØ­ + <span class="text-yellow-400 text-lg">Ø§ÛŒØ±Ø§Ù†</span></h1>
            <div class="flex items-center gap-4">
                <div id="userStatus" class="flex items-center text-sm">
                    <span id="currentUserTier" class="bg-blue-600 px-3 py-1 rounded-full text-xs font-semibold">Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†</span>
                </div>
                <button onclick="openModal('addAdModal')" class="bg-yellow-500 text-blue-900 px-4 py-2 rounded-full font-bold shadow hover:bg-yellow-400 transition">
                    <i class="fas fa-plus ml-2"></i>Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto p-4 py-8">
        <div class="bg-gradient-to-r from-orange-400 to-red-500 p-5 rounded-xl mb-8 text-white flex flex-col md:flex-row justify-between items-center shadow-lg">
            <div>
                <h2 class="text-2xl font-bold mb-2">ğŸ”¥ Ø§Ø´ØªØ±Ø§Ú© ÙˆÛŒÚ˜Ù‡ Ø¨Ú¯ÛŒØ±ÛŒØ¯ Ùˆ Ø¢Ú¯Ù‡ÛŒ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯!</h2>
                <p class="text-sm">Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ ØªØ§ Û±Û° Ø¨Ø±Ø§Ø¨Ø± Ø¨ÛŒØ´ØªØ± Ø¯ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ + Ú†Øª Ùˆ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯.</p>
            </div>
            <div class="flex flex-wrap gap-3 mt-4 md:mt-0">
                <button onclick="openSubscriptionModal('1month')" class="bg-white text-orange-700 px-5 py-2 rounded-lg font-bold shadow-md hover:bg-gray-100 transition">Û± Ù…Ø§Ù‡Ù‡</button>
                <button onclick="openSubscriptionModal('3month')" class="bg-white text-orange-700 px-5 py-2 rounded-lg font-bold shadow-md hover:bg-gray-100 transition">Û³ Ù…Ø§Ù‡Ù‡</button>
                <button onclick="openSubscriptionModal('6month')" class="bg-white text-orange-700 px-5 py-2 rounded-lg font-bold shadow-md hover:bg-gray-100 transition">Û¶ Ù…Ø§Ù‡Ù‡</button>
                <button onclick="openSubscriptionModal('12month')" class="bg-white text-orange-700 px-5 py-2 rounded-lg font-bold shadow-md hover:bg-gray-100 transition">Û±Û² Ù…Ø§Ù‡Ù‡</button>
            </div>
        </div>

        <div id="adsList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <p class="col-span-full text-center text-gray-500 animate-pulse">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§...</p>
        </div>
    </main>

    <div id="addAdModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[100] hidden">
        <div class="bg-white rounded-xl max-w-lg w-full p-6 shadow-2xl">
            <h2 class="text-2xl font-bold mb-5 text-gray-800">Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ Ø¬Ø¯ÛŒØ¯</h2>
            <input type="text" id="adTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¢Ú¯Ù‡ÛŒ (Ù…Ø«Ù„Ø§Ù‹: Ú¯ÙˆØ´ÛŒ Ø¢ÛŒÙÙˆÙ† 15 Ù¾Ø±ÙˆÙ…Ú©Ø³)" class="w-full border border-gray-300 p-3 rounded-lg mb-3 focus:ring-blue-500 focus:border-blue-500">
            <input type="number" id="adPrice" placeholder="Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)" class="w-full border border-gray-300 p-3 rounded-lg mb-3 focus:ring-blue-500 focus:border-blue-500">
            <textarea id="adDescription" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù…Ù„ Ø¢Ú¯Ù‡ÛŒ..." rows="4" class="w-full border border-gray-300 p-3 rounded-lg mb-3 focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
            <input type="file" id="adImage" accept="image/*" class="w-full border border-gray-300 p-3 rounded-lg mb-3">
            
            <div class="mb-4">
                <label class="inline-flex items-center">
                    <input type="checkbox" id="isVipAd" class="form-checkbox h-5 w-5 text-yellow-500 rounded focus:ring-yellow-500">
                    <span class="ml-2 text-gray-700 font-medium">Ø¢Ú¯Ù‡ÛŒ ÙˆÛŒÚ˜Ù‡ (VIP)</span>
                </label>
                <p class="text-sm text-gray-500 mt-1">Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡ ØªØ§ Û· Ø±ÙˆØ² Ø¯Ø± ØµØ¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. (Ù‡Ø²ÛŒÙ†Ù‡ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡)</p>
            </div>

            <div class="flex gap-3 justify-end">
                <button onclick="closeModal('addAdModal')" class="bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-medium hover:bg-gray-400 transition">Ø§Ù†ØµØ±Ø§Ù</button>
                <button onclick="submitAdHandler()" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg hover:bg-blue-700 transition">Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ</button>
            </div>
        </div>
    </div>

    <div id="adDetailsModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[110] hidden">
        <div class="bg-white rounded-xl max-w-4xl w-full flex flex-col h-[90vh] shadow-2xl overflow-hidden">
            <div id="detailsContent" class="flex-grow overflow-y-auto p-6 pb-2">
                </div>
            <div class="p-4 border-t border-gray-200 bg-gray-50">
                <h3 class="font-bold text-lg mb-3 text-gray-800">âœ‰ï¸ Ú†Øª Ø²Ù†Ø¯Ù‡ Ø¨Ø§ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ (ØªØ±Ø¬Ù…Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±)</h3>
                <div id="chatBox" class="h-48 overflow-y-auto bg-white border border-gray-300 p-3 mb-3 rounded-lg shadow-inner flex flex-col gap-2">
                    <p class="text-gray-400 text-center text-sm">Ø´Ø±ÙˆØ¹ Ù…Ú©Ø§Ù„Ù…Ù‡...</p>
                </div>
                <div class="flex gap-3">
                    <input type="text" id="chatInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." class="flex-grow border border-gray-300 p-3 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <button onclick="sendMessage()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-blue-700 transition">
                        <i class="fas fa-paper-plane"></i> Ø§Ø±Ø³Ø§Ù„
                    </button>
                </div>
            </div>
            <button onclick="closeModal('adDetailsModal')" class="w-full bg-gray-200 text-gray-700 py-3 font-bold hover:bg-gray-300 transition">Ø¨Ø³ØªÙ†</button>
        </div>
    </div>

    <div id="subscriptionModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[100] hidden">
        <div class="bg-white rounded-xl max-w-md w-full p-6 shadow-2xl text-center">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú© ÙˆÛŒÚ˜Ù‡</h2>
            <p class="mb-4 text-gray-600">Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„Ø³Ø§Ø²ÛŒ Ø§Ø´ØªØ±Ø§Ú©ØŒ Ù…Ø¨Ù„Øº Ø±Ø§ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø²ÛŒØ± ÙˆØ§Ø±ÛŒØ² Ùˆ Ø±Ø³ÛŒØ¯ Ø±Ø§ Ø¯Ø± Ú†Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ (ÛŒØ§ Ø¨Ø§ Ø§ÛŒÙ…ÛŒÙ„) Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯. Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§ÛŒÛŒØ¯ ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ±ÛŒØªØŒ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
            
            <div class="bg-blue-50 p-4 rounded-lg mb-5 border border-blue-200">
                <p class="font-bold text-blue-800 mb-2">Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª: <span class="text-2xl text-blue-600">Û¶Û±Û°Û´-Û³Û³Û·Û¸-Û¹Û°Û°Û±-Û²Û³Û´Ûµ</span></p>
                <p class="text-gray-700">Ù†Ø§Ù… ØµØ§Ø­Ø¨ Ø­Ø³Ø§Ø¨: Ù…Ù‡Ø¯ÛŒ Ø¹ÛŒØ¯Ø§Ù†ÛŒ</p>
                <p class="text-sm text-gray-500 mt-2">ØªÙˆØ¬Ù‡: Ù…Ø¨Ù„Øº Ø¯Ù‚ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯ÙˆØ±Ù‡ (Û±ØŒ Û³ØŒ Û¶ ÛŒØ§ Û±Û² Ù…Ø§Ù‡Ù‡) Ø±Ø§ Ø§Ø² Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ù¾Ø±Ø³ÛŒØ¯.</p>
            </div>
            
            <button onclick="closeModal('subscriptionModal')" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 transition">Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…</button>
        </div>
    </div>

    <script type="module">
        import { db, ref, onValue, push, update, get, generateUserId, isVipExpired, saveAdToDB, updateUserAdCount, autoTranslate } from "./app.js";

        // --- Global State ---
        let currentUserId = generateUserId();
        let currentUser = { id: currentUserId, tier: "free", adCount: 0, vipExpires: 0 };
        let activeChatAdId = null; // Which ad's chat is currently open

        // --- UI Helper Functions ---
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        window.openModal = openModal; // Make accessible globally
        window.closeModal = closeModal; // Make accessible globally

        // --- User State Management ---
        onValue(ref(db, `users/${currentUserId}`), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                currentUser = { ...currentUser, ...data };
                if (isVipExpired(currentUser)) {
                    currentUser.tier = 'free';
                    update(ref(db, `users/${currentUserId}`), { tier: 'free' }); // Update in DB if expired
                }
            } else {
                // Initialize new user in DB if not exists
                push(ref(db, `users/${currentUserId}`), { tier: "free", adCount: 0, createdAt: Date.now() });
            }
            updateUserUI();
        });

        function updateUserUI() {
            const userTierElement = document.getElementById('currentUserTier');
            if (currentUser.tier === 'vip') {
                userTierElement.textContent = 'Ú©Ø§Ø±Ø¨Ø± ÙˆÛŒÚ˜Ù‡ (VIP)';
                userTierElement.className = 'bg-yellow-500 text-red-900 px-3 py-1 rounded-full text-xs font-semibold';
            } else {
                userTierElement.textContent = `Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ ( ${2 - currentUser.adCount} Ø¢Ú¯Ù‡ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡)`;
                userTierElement.className = 'bg-blue-600 px-3 py-1 rounded-full text-xs font-semibold';
            }
        }

        // --- Ad Submission Handler ---
        window.submitAdHandler = async () => {
            const title = document.getElementById('adTitle').value;
            const price = document.getElementById('adPrice').value;
            const description = document.getElementById('adDescription').value;
            const imageFile = document.getElementById('adImage').files[0];
            const isVip = document.getElementById('isVipAd').checked;

            if (!title || !price) { alert("Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù‚ÛŒÙ…Øª Ø¢Ú¯Ù‡ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª!"); return; }

            if (currentUser.tier === 'free' && currentUser.adCount >= 2 && !isVip) {
                alert("âŒ Ø´Ù…Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒØŒ ÙÙ‚Ø· Û² Ø¢Ú¯Ù‡ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¯Ø± Ù…Ø§Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ± ÛŒØ§ Ø¢Ú¯Ù‡ÛŒ ÙˆÛŒÚ˜Ù‡ØŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø´ØªØ±Ø§Ú© VIP ØªÙ‡ÛŒÙ‡ Ú©Ù†ÛŒØ¯.");
                return;
            }

            const adData = {
                title, price, description,
                status: 'pending', // Awaiting admin approval
                type: isVip ? 'vip' : 'normal',
                ownerId: currentUserId,
                createdAt: Date.now(),
                vipExpiresAt: isVip ? Date.now() + (7 * 24 * 60 * 60 * 1000) : 0 // 7 days VIP
            };

            await saveAdToDB(adData, imageFile);
            await updateUserAdCount(currentUserId);

            alert("âœ… Ø¢Ú¯Ù‡ÛŒ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ùˆ Ù…Ù†ØªØ¸Ø± ØªØ§ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³Øª.");
            closeModal('addAdModal');
            // Clear form
            document.getElementById('adTitle').value = '';
            document.getElementById('adPrice').value = '';
            document.getElementById('adDescription').value = '';
            document.getElementById('adImage').value = '';
            document.getElementById('isVipAd').checked = false;
        };

        // --- Display Ads ---
        onValue(ref(db, 'ads'), (snapshot) => {
            const adsList = document.getElementById('adsList');
            adsList.innerHTML = '';
            const adsData = snapshot.val();
            let adsArray = [];
            for (let id in adsData) {
                adsArray.push({ id, ...adsData[id] });
            }

            // Sort: VIP ads first, then by creation date (newest first)
            adsArray.sort((a, b) => {
                if (a.type === 'vip' && b.type !== 'vip') return -1;
                if (a.type !== 'vip' && b.type === 'vip') return 1;
                return b.createdAt - a.createdAt;
            });

            if (adsArray.length === 0) {
                adsList.innerHTML = '<p class="col-span-full text-center text-gray-500">Ù‡Ù†ÙˆØ² Ø¢Ú¯Ù‡ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
                return;
            }

            adsArray.forEach(ad => {
                if (ad.status === 'approved') {
                    const adCard = document.createElement('div');
                    adCard.className = `bg-white p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition ${ad.type === 'vip' ? 'vip-card' : ''}`;
                    adCard.onclick = () => showAdDetails(ad.id);
                    adCard.innerHTML = `
                        ${ad.type === 'vip' ? '<span class="vip-badge">ÙˆÛŒÚ˜Ù‡</span>' : ''}
                        <img src="${ad.imageUrl || 'https://via.placeholder.com/300x180?text=Ø¨Ø¯ÙˆÙ†+Ø¹Ú©Ø³'}" alt="${ad.title}" class="ad-image mb-3">
                        <h3 class="font-bold text-lg mb-1">${ad.title}</h3>
                        <p class="text-blue-600 font-bold text-xl mb-2">${Number(ad.price).toLocaleString()} ØªÙˆÙ…Ø§Ù†</p>
                        <p class="text-gray-600 text-sm line-clamp-2">${ad.description || 'ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.'}</p>
                        <div class="mt-4 flex justify-between items-center text-xs text-gray-400">
                            <span><i class="fas fa-clock ml-1"></i>${new Date(ad.createdAt).toLocaleDateString('fa-IR')}</span>
                            <button onclick="event.stopPropagation(); toggleBookmark('${ad.id}')" class="text-gray-400 hover:text-red-500 transition">
                                <i id="bookmark-${ad.id}" class="far fa-heart"></i>
                            </button>
                        </div>
                    `;
                    adsList.appendChild(adCard);
                }
            });
        });

        // --- Ad Details & Chat ---
        window.showAdDetails = async (adId) => {
            const adSnap = await get(ref(db, `ads/${adId}`));
            const ad = adSnap.val();
            if (!ad) return;

            activeChatAdId = adId; // Set active chat ad
            const detailsContent = document.getElementById('detailsContent');
            detailsContent.innerHTML = `
                <img src="${ad.imageUrl || 'https://via.placeholder.com/600x400?text=Ø¨Ø¯ÙˆÙ†+Ø¹Ú©Ø³'}" alt="${ad.title}" class="w-full h-64 object-cover rounded-lg mb-4">
                <h2 class="text-3xl font-bold mb-3 text-gray-900">${ad.title}</h2>
                <p class="text-green-600 font-bold text-3xl mb-4">${Number(ad.price).toLocaleString()} ØªÙˆÙ…Ø§Ù†</p>
                <p class="text-gray-700 text-lg leading-relaxed mb-6">${ad.description || 'ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù…Ù„â€ŒØªØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¢Ú¯Ù‡ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.'}</p>
                <div class="flex items-center text-gray-500 text-sm mb-2">
                    <i class="fas fa-clock ml-2"></i><span>ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª: ${new Date(ad.createdAt).toLocaleDateString('fa-IR')}</span>
                </div>
                <div class="flex items-center text-gray-500 text-sm mb-6">
                    <i class="fas fa-user ml-2"></i><span>Ø´Ù†Ø§Ø³Ù‡ Ø¢Ú¯Ù‡ÛŒâ€ŒØ¯Ù‡Ù†Ø¯Ù‡: ${ad.ownerId}</span>
                </div>
                <hr class="mb-4">
            `;
            openModal('adDetailsModal');
            loadChatMessages(adId);
        };

        window.loadChatMessages = (adId) => {
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML = '<p class="text-gray-400 text-center text-sm">Ø´Ø±ÙˆØ¹ Ù…Ú©Ø§Ù„Ù…Ù‡...</p>'; // Clear and show loading
            onValue(ref(db, `chats/${adId}`), async (snapshot) => {
                chatBox.innerHTML = ''; // Clear for new messages
                const messages = snapshot.val();
                if (messages) {
                    for (let msgId in messages) {
                        const msg = messages[msgId];
                        const bubble = document.createElement('div');
                        const isOwner = msg.sender === currentUserId;
                        bubble.className = `chat-bubble text-sm ${isOwner ? 'chat-owner self-end' : 'chat-other self-start'}`;
                        
                        // Display translated text if available, otherwise original
                        let displayTxt = msg.text;
                        if (msg.translatedText && msg.translatedText !== msg.text) {
                            displayTxt = `(${msg.text}) ${msg.translatedText}`;
                        }
                        
                        bubble.innerHTML = `
                            <p class="font-medium">${displayTxt}</p>
                            <span class="text-xs text-gray-500 mt-1 block">${new Date(msg.timestamp).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' })}</span>
                        `;
                        chatBox.appendChild(bubble);
                    }
                }
                chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom
            });
        };

        window.sendMessage = async () => {
            const chatInput = document.getElementById('chatInput');
            const msg = chatInput.value.trim();
            if (!msg || !activeChatAdId) return;

            chatInput.value = ''; // Clear input immediately

            const translatedText = await autoTranslate(msg, 'en'); // Translate to English for example, then display both
            
            push(ref(db, `chats/${activeChatAdId}`), {
                sender: currentUserId,
                text: msg,
                translatedText: translatedText,
                timestamp: Date.now()
            });
        };

        // --- Bookmark Ad ---
        window.toggleBookmark = (adId) => {
            const bookmarkIcon = document.getElementById(`bookmark-${adId}`);
            if (bookmarkIcon.classList.contains('far')) { // Not bookmarked
                bookmarkIcon.classList.remove('far');
                bookmarkIcon.classList.add('fas');
                bookmarkIcon.classList.add('text-red-500');
                push(ref(db, `users/${currentUserId}/bookmarks`), adId);
                alert('Ø¢Ú¯Ù‡ÛŒ Ù†Ø´Ø§Ù† Ø´Ø¯!');
            } else { // Bookmarked
                bookmarkIcon.classList.remove('fas');
                bookmarkIcon.classList.remove('text-red-500');
                bookmarkIcon.classList.add('far');
                // TODO: Remove from bookmarks in DB (more complex, requires searching)
                alert('Ø¢Ú¯Ù‡ÛŒ Ø§Ø² Ù†Ø´Ø§Ù† Ø®Ø§Ø±Ø¬ Ø´Ø¯!');
            }
        };
        
        // --- Subscription Modal ---
        window.openSubscriptionModal = (duration) => {
            // Here you might show different pricing based on duration
            // For now, just show the generic payment modal
            openModal('subscriptionModal');
        };

    </script>
</body>
</html>